
<!DOCTYPE HTML>
<html>
<head>
	<script data-cfasync="false" type="text/javascript" src="//use.typekit.net/axj3cfp.js"></script>
	<script data-cfasync="false" type="text/javascript">try{Typekit.load();}catch(e){}</script>
	<meta charset="utf-8">
	<title>Channel Bonding Interfaces the RedHat 6.x way  | Keith Hurlic</title>

<meta name="author" content="Keith Hurlic"> 

<meta name="description" content="from Los Angeles"> <meta name="keywords" content="">

	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

	<link href="/atom.xml" rel="alternate" title="Keith Hurlic" type="application/atom+xml">
	<link rel="canonical" href="">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
	<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js"></script>

<script language="Javascript" type="text/javascript">
$(document).ready(
  function() {
    (function($) {
      $(".fancybox[data-content-id]").each(function() {
        this.href = $(this).data('content-id');
      });
      $(".fancybox").fancybox({
        beforeLoad: function() {
          var el, 
              id = $(this.element).data('title-id');

          if (id) {
            el = $('#' + id);

            if (el.length) {
              this.title = el.html();
            }
          }
          if ($(this).data('content')) {
            this.content = $(this).data('content');
          }
        },
        helpers: {
          title: {
            type: 'inside'
          }
        }
      });
    })(jQuery);
  }
);
</script>

	
</head>


<body>
	<header id="header" class="inner"><h1><a href="/">Keith Hurlic</a></h1>
<h4>Sr. Systems Engineer by day. Forever a Skateboarder at heart.</h4>
<nav id="main-nav"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</nav>
<nav id="mobile-nav">
	<div class="alignleft menu">
		<a class="button">Menu</a>
		<div class="container"><ul>
	<li><a href="/">Blog</a></li>
	<li><a href="/about">About</a></li>
	<li><a href="/portfolio">Portfolio</a></li>
	<li><a href="/archives">Archive</a></li>
</ul>
</div>
	</div>
	<div class="alignright search">
		<a class="button"></a>
		<div class="container">
			<form action="http://google.com/search" method="get">
				<input type="text" name="q" results="0">
				<input type="hidden" name="q" value="site:khurlic.github.io">
			</form>
		</div>
	</div>
</nav>


</header>

	<div id="content" class="inner"><article class="post">
	<h2 class="title">Channel Bonding Interfaces the RedHat 6.x Way</h2>
	<div class="entry-content"><p>Recently at work, I received an email from my networking team on why they were seeing the following error.</p>

<p>%SW_MATM-4-MACFLAP_NOTIF: Host dddd.dddd.dddd in vlan 100 is flapping between port Te1/0/1 and port Gi2/0/22.</p>

<p>I tracked down the mac from the message above. (mac changed for security) I logged in to the box and discovered that the nic bond was running in mode 0 instead of mode 1 which it was configured for. The root cause was Red Hat changed the way parameters for the bonding kernel module were loaded. Starting in RHEL 6.0 you’ll need to add the bonding options to the bonded interface file (ifcfg-bondX).</p>

<p>Here are the commands I took to correct the issue.</p>

<p><strong>Verify bonding mode</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat /sys/class/net/bond0/bonding/mode</span>
</span><span class='line'>balance-rr 0
</span><span class='line'>
</span><span class='line'><span class="c"># cat /proc/net/bonding/bond0 | grep -i mode</span>
</span><span class='line'>Bonding Mode: load balancing <span class="o">(</span>round-robin<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># cat /etc/modprobe.d/bonding.conf</span>
</span><span class='line'><span class="nb">alias </span>bond0 bonding
</span><span class='line'>options bond0 <span class="nv">mode</span><span class="o">=</span>1 <span class="nv">miimon</span><span class="o">=</span>100
</span></code></pre></td></tr></table></div></figure>


<p><strong>Make changes</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># sed -i&#39;.bak&#39; -e &#39;/options.*/d&#39; /etc/modprobe.d/bonding.conf</span>
</span><span class='line'><span class="c"># echo &#39;BONDING_OPTS=&quot;mode=1 miimon=100&quot;&#39; &gt;&gt; /etc/sysconfig/networking-scripts/ifcfg-bond0</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Restart Network</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># service network restart</span>
</span></code></pre></td></tr></table></div></figure>


<p><strong>Verify bonding mode</strong></p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="c"># cat /sys/class/net/bond0/bonding/mode</span>
</span><span class='line'>active-backup 1
</span><span class='line'>
</span><span class='line'><span class="c"># cat /proc/net/bonding/bond0 | grep -i mode</span>
</span><span class='line'>Bonding Mode: fault-tolerance <span class="o">(</span>active-backup<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="c"># cat /etc/modprobe.d/bonding.conf</span>
</span><span class='line'><span class="nb">alias </span>bond0 bonding
</span></code></pre></td></tr></table></div></figure>


<h1>Setting up nic bonding from scratch</h1>

<hr />

<p>Change all of the example IP addresses from 1.1.1.x to the IP addresses that work in your environment.</p>

<p>1.) Edit the  /etc/modprobe.d/bonding.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi /etc/modprobe.d/bonding.conf</span>
</span><span class='line'><span class="nb">alias </span>bond0 bonding
</span></code></pre></td></tr></table></div></figure>


<p>2.) Edit the /etc/sysconfig/network</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi /etc/sysconfig/network</span>
</span><span class='line'><span class="nv">NETWORKING</span><span class="o">=</span>yes
</span><span class='line'><span class="nv">HOSTNAME</span><span class="o">=</span>your.hostname.here
</span><span class='line'><span class="nv">GATEWAY</span><span class="o">=</span>1.1.1.1
</span></code></pre></td></tr></table></div></figure>


<p>3.) Edit the /etc/resolv.conf</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi /etc/resolv.conf</span>
</span><span class='line'>search example.com
</span><span class='line'>nameserver 1.1.1.2
</span><span class='line'>nameserver 1.1.1.3
</span></code></pre></td></tr></table></div></figure>


<p>4.) Edit the /etc/sysconfig/network-scripts/ifcfg-bond0</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi  /etc/sysconfig/network-scripts/ifcfg-bond0</span>
</span><span class='line'><span class="nv">DEVICE</span><span class="o">=</span>bond0
</span><span class='line'><span class="nv">USERCTL</span><span class="o">=</span>no
</span><span class='line'><span class="nv">BOOTPROTO</span><span class="o">=</span>none
</span><span class='line'><span class="nv">ONBOOT</span><span class="o">=</span>yes
</span><span class='line'><span class="nv">USERCTL</span><span class="o">=</span>no
</span><span class='line'><span class="nv">IPADDR</span><span class="o">=</span>1.1.1.100
</span><span class='line'><span class="nv">NETMASK</span><span class="o">=</span>255.255.255.0
</span><span class='line'><span class="nv">BONDING_OPTS</span><span class="o">=</span>”mode<span class="o">=</span>1 <span class="nv">miimon</span><span class="o">=</span>100″
</span></code></pre></td></tr></table></div></figure>


<p>5.) Edit the  /etc/sysconfig/network-scripts/ifcfg-eth0</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi  /etc/sysconfig/network-scripts/ifcfg-eth0</span>
</span><span class='line'><span class="nv">DEVICE</span><span class="o">=</span>”eth0″
</span><span class='line'><span class="nv">SLAVE</span><span class="o">=</span>”yes”
</span><span class='line'><span class="nv">ONBOOT</span><span class="o">=</span>”yes”
</span><span class='line'><span class="nv">MASTER</span><span class="o">=</span>”bond0″
</span><span class='line'><span class="nv">USERCTL</span><span class="o">=</span>”no”
</span><span class='line'><span class="nv">BOOTPROTO</span><span class="o">=</span>none
</span><span class='line'><span class="nv">NM_CONTROLLED</span><span class="o">=</span>”no”
</span></code></pre></td></tr></table></div></figure>


<p>6.) Edit the  /etc/sysconfig/network-scripts/ifcfg-eth1</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># vi  /etc/sysconfig/network-scripts/ifcfg-eth1</span>
</span><span class='line'><span class="nv">DEVICE</span><span class="o">=</span>”eth1″
</span><span class='line'><span class="nv">SLAVE</span><span class="o">=</span>”yes”
</span><span class='line'><span class="nv">ONBOOT</span><span class="o">=</span>”yes”
</span><span class='line'><span class="nv">MASTER</span><span class="o">=</span>”bond0″
</span><span class='line'><span class="nv">USERCTL</span><span class="o">=</span>”no”
</span><span class='line'><span class="nv">BOOTPROTO</span><span class="o">=</span>none
</span><span class='line'><span class="nv">NM_CONTROLLED</span><span class="o">=</span>”no”
</span></code></pre></td></tr></table></div></figure>


<p>7.) Load the bonding kernel module</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># modprobe bonding</span>
</span></code></pre></td></tr></table></div></figure>


<p>8.) restart the network</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># service network restart</span>
</span></code></pre></td></tr></table></div></figure>


<p>9.) Verify changes</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
<span class='line-number'>12</span>
<span class='line-number'>13</span>
<span class='line-number'>14</span>
<span class='line-number'>15</span>
<span class='line-number'>16</span>
<span class='line-number'>17</span>
<span class='line-number'>18</span>
<span class='line-number'>19</span>
<span class='line-number'>20</span>
<span class='line-number'>21</span>
<span class='line-number'>22</span>
<span class='line-number'>23</span>
<span class='line-number'>24</span>
<span class='line-number'>25</span>
<span class='line-number'>26</span>
<span class='line-number'>27</span>
<span class='line-number'>28</span>
<span class='line-number'>29</span>
<span class='line-number'>30</span>
<span class='line-number'>31</span>
</pre></td><td class='code'><pre><code class='bash'><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># ping 1.1.1.1</span>
</span><span class='line'>
</span><span class='line'>PING 1.1.1.1 <span class="o">(</span>1.1.1.1<span class="o">)</span> 56<span class="o">(</span>84<span class="o">)</span> bytes of data.
</span><span class='line'>64 bytes from 1.1.1.1: <span class="nv">icmp_seq</span><span class="o">=</span>1 <span class="nv">ttl</span><span class="o">=</span>255 <span class="nb">time</span><span class="o">=</span>1.89 ms
</span><span class='line'>64 bytes from 1.1.1.1: <span class="nv">icmp_seq</span><span class="o">=</span>2 <span class="nv">ttl</span><span class="o">=</span>255 <span class="nb">time</span><span class="o">=</span>0.872 ms
</span><span class='line'>64 bytes from 1.1.1.1: <span class="nv">icmp_seq</span><span class="o">=</span>3 <span class="nv">ttl</span><span class="o">=</span>255 <span class="nb">time</span><span class="o">=</span>2.25 ms
</span><span class='line'>64 bytes from 1.1.1.1: <span class="nv">icmp_seq</span><span class="o">=</span>4 <span class="nv">ttl</span><span class="o">=</span>255 <span class="nb">time</span><span class="o">=</span>0.880 ms
</span><span class='line'>
</span><span class='line'>— 1.1.1.1 ping statistics —
</span><span class='line'>4 packets transmitted, 4 received, 0% packet loss, <span class="nb">time </span>3003ms
</span><span class='line'>rtt min/avg/max/mdev <span class="o">=</span> 0.872/1.476/2.253/0.612 ms
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># host www.google.com</span>
</span><span class='line'>host www.google.com
</span><span class='line'>www.google.com has address 74.125.224.177
</span><span class='line'>www.google.com has address 74.125.224.178
</span><span class='line'>www.google.com has address 74.125.224.179
</span><span class='line'>www.google.com has address 74.125.224.180
</span><span class='line'>www.google.com has address 74.125.224.176
</span><span class='line'>www.google.com has IPv6 address 2607:f8b0:4007:800::1010
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># cat /proc/net/bonding/bond0 | grep -i mode</span>
</span><span class='line'>Bonding Mode: fault-tolerance <span class="o">(</span>active-backup<span class="o">)</span>
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># cat /sys/class/net/bond0/bonding/mode</span>
</span><span class='line'>active-backup 1
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># ifdown eth0</span>
</span><span class='line'>from another host ping your server, <span class="k">if </span>the ping is good, <span class="k">then </span>ssh to it. If you can reach your server via ping and ssh <span class="k">then </span>the nic bonding is working as it should.
</span><span class='line'>
</span><span class='line'><span class="o">[</span>root@host ~<span class="o">]</span><span class="c"># ifup eth0</span>
</span></code></pre></td></tr></table></div></figure>


<p>Reference.</p>

<p><a href="https://access.redhat.com/site/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Deployment_Guide/s2-networkscripts-interfaces-chan.html" title="RedHat Docs">Redhat Docs for bonding</a></p>
</div>


<div class="meta">
	<div class="date">








  


<time datetime="2014-01-30T20:35:32-08:00" pubdate data-updated="true">Jan 30<span>th</span>, 2014</time></div>
	

<div class="tags">

	<a class='category' href='/blog/categories/linux/'>linux</a>, <a class='category' href='/blog/categories/tech/'>tech</a>

</div>


	
</div></article>

	<div class="share">
	<div class="addthis_toolbox addthis_default_style ">
	
	
	<a class="addthis_button_tweet"></a>
	
	
	<a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
	
<!---	<a class="addthis_counter addthis_pill_style"></a> --->
	</div>
  <script type="text/javascript" src="http://s7.addthis.com/js/250/addthis_widget.js#pubid="></script>
</div>


</div>
	<footer id="footer" class="inner">Copyright &copy; 2014

    Keith Hurlic

<br>
Powered by Octopress.
</footer>
	<script src="/javascripts/slash.js"></script>
<script src="/javascripts/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
	$('.fancybox').fancybox();
})(jQuery);
</script> <!-- Delete or comment this line to disable Fancybox -->






</body>
</html>
